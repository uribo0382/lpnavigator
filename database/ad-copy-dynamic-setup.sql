-- ====================================
-- 広告文生成機能の動的化に必要なSQL
-- ====================================

-- 1. ad_copies テーブルの確認と必要なカラム追加
-- 既存のテーブル構造は以下の通り：
-- - id, user_id, basic_info_id, title, content, summary
-- - generated_by (AIモデル名), formula_id, created_at, updated_at

-- AdCopyGeneratorコンポーネントで使用している「source」フィールドに対応するため、
-- generated_byカラムをsourceとして使用します（既に存在）

-- 2. 広告文フォーミュラのサンプルデータ挿入
-- モックデータに基づいて11個の広告文フォーミュラを挿入
INSERT INTO formulas (name, type, template, variables, is_active, summary) VALUES
('質問型（ほかにいませんか？）', 'ad_copy', 
'{{ニュースキャッチの抽出。トピックに関連する内容}}
・{{ニュースにつき好奇心を持つような質問文}}？
・{{ニュースにつき好奇心を持つような質問文}}？
・{{ニュースにつき好奇心を持つような質問文}}？
{{署名}}によると、{{意外で面白い内容を2-3行で解説}}したそうです。
さらに、調べれば調べるほどに、{{さらに意外で面白い内容を紹介}}することがわかりました。また、{{アバターにとって意味のある結論。大きなチャレンジ、または大きな機会が訪れそうだ}}ということです。
それならば、{{アバターが望める結果}}を得るためには、どうすれば良いのでしょうか？
{{よくある懸念}}や{{よくある懸念}}はどう考えればいいのでしょうか？
この情報は、{{権威}}である、あなたにとっての{{価値}}です。', 
ARRAY['ニュースキャッチ', '質問文', '署名', '意外な内容', 'アバター', '懸念', '権威', '価値'], 
true, 
'好奇心を刺激する質問を通して読者の興味を引き、ニュースやトピックに関連する意外な情報を提供し、商品・サービスの価値を伝えるフォーミュラです。読者に「もっと知りたい」と思わせる広告文に最適です。'),

('誠実型', 'ad_copy',
'{{商品名}}
この{{対象}}を手にしたとき、
私は自分の目が信じられませんでした。
あなたもきっと同じ感動を覚えるでしょう。
From：{{名前}}
これからお話しすることは本当の話です。信じていただけるか不安ですが、信じていただけないあなたには、人生を変える価値があることを知っていただけるようにしたいと思います。まずは最後まで読んでください。
{{新しい商品を紹介された人}}は{{精通している、または、優れた眼力を持つなどの状況}}でした。彼の隣で{{新しい商品を紹介したときのシーンを描写}}と言われました。
{{新しい商品に対する、あなたの疑問や難点。または、紹介者とのあいだの具体的なシーンの描写}}
{{新しい商品を使ってみた}}みたところ私が目を疑いました。そして何度か{{再び新しい商品を使うシーン}}して、本当に{{商品の効果を確認する}}のかどうか確認したのです。すると、確かに{{商品の効果}}していました。これは明らかでした。{{既存の商品や手法}}と比較してみましたが、とても及ばないものになりません。私はとても驚きました。{{商品のベネフィット}}したのです。ではなぜこの商品はこれほど{{商品ベネフィット}}できるのでしょうか？その理由をねくり返してみました。',
ARRAY['商品名', '対象', '名前', '紹介された人', '状況', 'シーン', '疑問', '商品の効果', '既存の商品', 'ベネフィット'],
true,
'商品やサービスを誠実かつ詳細に説明し、ユーザーの信頼を獲得するフォーミュラです。商品の効果や仕組みを丁寧に解説し、既存の商品との違いを明確にすることで、ユーザーの購入意欲を高めます。透明性と信頼性を重視した広告文作成に適しています。'),

('問題共感型', 'ad_copy',
'{{地域}}にお住まいの皆様
今日、あなたが{{悩み}}で悩んでいたら、ぜひお読みください。
はじめまして、{{社名または責任者の名前}}です。{{商品カテゴリー}}の中でもハイクオリティなものを探したことがある人なら、本当に良い{{商品カテゴリー}}はとても高価です。{{商品}}も{{高額}}円するのですが、{{地域}}では{{安価であることを伝える}}ところです。 
なぜ、そんなに高価なのに、業者さんが宣伝をしないのかという合理的な理由が1つあります。それはどこに行っても{{効果}}がないような{{症状}}や{{効果}}を与える{{技術などの要因}}があるからです。
それでなければ、このような高価設定はしませんし、お客さんが集まるわけもありません。
もしも、あなたが「{{トピックに関して困っていること}}していてもなかなか{{症状が良くならない}}」という方に悩んでいたら、{{地域}}で最も高価な優れた{{商品やサービス}}を一度お試しください。この悩みが解消する自信があります。そして、{{従来品や類似商品}}をお持ちであれば、今すぐ、時間をかけていられないと感じるものを探してきていただきたいのです。このような意味では、優れた{{商品やサービス}}は、どうしても「必要」と思います。
とはいえですが、上にも書いてあるように、優れた{{商品やサービス}}は高価です。{{高額}}円というのは一般的に、それなりの金額だと思います。なのでこの度、特別にモニター募集を打ち出してみることにしました。
本件につき、アンケートに答えていただけるかたに、{{モニター価格}}円で、通常の施術を受けられるようにしました。このモニター枠は、{{人数}}名の枠しか設けていないので、早いものに埋まってしまいますと思います。{{地域}}で最も人気のある、最も効果の優れたものをお探しの方は、今すぐご連絡でご予約ください。',
ARRAY['地域', '悩み', '社名または責任者', '商品カテゴリー', '商品', '高額', '効果', '症状', '技術', 'トピック', 'モニター価格', '人数'],
true,
'ユーザーの問題や悩みに共感し、解決策を提案するフォーミュラです。地域密着型のサービスや商品に特に効果的で、高品質な商品やサービスを特別価格で提供する「モニター募集」の形式でユーザーの興味を引きます。共感と解決策の提示を通じて信頼関係を構築します。'),

('ニュース提供型', 'ad_copy',
'【{{ニュースのトピック}}】最新情報をお届けします
{{挨拶}}
先日、{{ニュースソース}}による最新の報告で、{{ニュースの内容}}という情報が発表されました。
これはあなたにとって非常に重要な情報です。なぜなら、この変化によって{{ユーザーへの影響}}ことになるからです。
具体的には、以下の3つの変化が起こります：
1. {{具体的な変化1}}
2. {{具体的な変化2}}
3. {{具体的な変化3}}
特に注目すべきは、{{特に重要な変化や数字}}という点です。これは{{その重要性の説明}}ということを意味します。',
ARRAY['ニュースのトピック', '挨拶', 'ニュースソース', 'ニュースの内容', 'ユーザーへの影響', '具体的な変化1', '具体的な変化2', '具体的な変化3', '重要な変化', '重要性の説明'],
true,
'最新のニュースや業界情報を提供することで、ユーザーの関心を引き、価値ある情報源としての地位を確立するフォーミュラです。情報提供を通じて信頼性を構築し、その上で関連するソリューションを提案することで、自然な形での商品・サービスの紹介が可能になります。'),

('一緒に疑う', 'ad_copy',
'【{{トピック}}】あなたは本当にこれを信じますか？
{{挨拶}}
あなたは{{一般的な誤解や業界の通説}}と聞いたことがありますか？
多くの人がこれを信じていますが、実は完全な真実ではないかもしれません。
私たちは何年もの間、{{業界や分野}}において{{一般的な慣行や方法}}を当然のように受け入れてきました。しかし、最近の{{研究や調査}}によると、実はこれが{{問題点や誤解}}であることが明らかになってきました。
例えば：
- {{具体的な誤解や問題点1}}
- {{具体的な誤解や問題点2}}
- {{具体的な誤解や問題点3}}',
ARRAY['トピック', '挨拶', '一般的な誤解', '業界や分野', '一般的な慣行', '研究や調査', '問題点', '誤解1', '誤解2', '誤解3'],
true,
'一般的な通説や業界の常識に疑問を投げかけ、新しい視点や解決策を提案するフォーミュラです。ユーザーと一緒に「常識」を疑うことで共感を生み出し、既存の方法に不満や疑問を持っているユーザーの興味を強く引きます。革新的な商品やサービスの紹介に特に効果的です。'),

('成果保証型', 'ad_copy',
'【保証】{{具体的な成果}}または全額返金！
{{挨拶}}
「{{ユーザーの一般的な不満や問題}}」
このような悩みを抱えていませんか？
実は、この問題を抱えているのはあなただけではありません。多くの{{ターゲットユーザー}}が同じ悩みを持っています。
しかし、今日からはその悩みとサヨナラできます。
私たちの{{商品・サービス名}}は、{{具体的な成果や効果}}を保証します。もし結果が出なければ、全額返金いたします。
なぜそこまで自信があるのか？',
ARRAY['具体的な成果', '挨拶', '不満や問題', 'ターゲットユーザー', '商品・サービス名', '成果や効果'],
true,
'具体的な成果を保証し、リスクを取り除くことでユーザーの購入障壁を下げるフォーミュラです。「全額返金保証」という強力な約束と、実際の成功事例を組み合わせることで信頼性を高め、限定特典や期間限定オファーで即時行動を促します。結果に自信がある商品やサービスに特に効果的です。'),

('お願い型', 'ad_copy',
'{{緊急性の高いタイトル}}
{{挨拶}}
今日は少し恥ずかしいお願いをしようと思います。でも、私たちが抱えている{{課題や問題}}を解決するためには、あなたのお力が必要なのです。
実は、私たちは現在{{現状の説明}}という状況に直面しています。
このままでは、{{放置した場合の悪影響}}という深刻な事態になりかねません。
特に{{特に影響を受ける人々や対象}}にとっては、{{具体的な影響}}という結果になるでしょう。
私たちは今までも{{これまでの取り組み}}を行ってきましたが、残念ながらそれだけでは不十分です。この状況を打開するためには、あなたのような{{ターゲットの特性}}の方々のサポートが必要不可欠なのです。
お願いは簡単です。',
ARRAY['タイトル', '挨拶', '課題や問題', '現状の説明', '悪影響', '影響を受ける人々', '具体的な影響', '取り組み', 'ターゲットの特性'],
true,
'読者に対して直接的かつ誠実にお願いする形式で、共感や協力意識を呼び起こすフォーミュラです。問題や課題を明確に伝え、読者の協力が必要な理由と、協力することによる効果やメリットを強調します。社会的意義のある取り組みや、支援が必要なプロジェクトの広告に特に効果的です。'),

('写真と割引型', 'ad_copy',
'【最大{{割引率}}％OFF】{{商品・サービス名}}の特別キャンペーン実施中！
{{画像の説明や挿入指示}}
{{挨拶}}
今日は特別なお知らせがあります！
期間限定で、当社の人気商品「{{商品・サービス名}}」が通常価格{{通常価格}}円から、最大{{割引率}}％OFFの{{割引後価格}}円でご提供いたします！
{{商品・サービスの概要説明}}
この{{商品・サービス名}}の特徴は：
✓ {{特徴・メリット1}}',
ARRAY['割引率', '商品・サービス名', '画像説明', '挨拶', '通常価格', '割引後価格', '概要説明', '特徴1'],
true,
'ビジュアル要素（写真や画像）と割引キャンペーンを組み合わせた、商品やサービスの購入を直接的に促すフォーミュラです。視覚的な魅力と価格メリットを前面に押し出し、特典や期間限定性を強調することで即時行動を促します。実店舗や商品、サービスの魅力を視覚的にアピールできる広告に最適です。'),

('招待状型', 'ad_copy',
'【ご招待】{{特別なイベントやオファー}}へのご案内
{{挨拶}}
この度、{{会社・団体名}}では、厳選された方々に向けて、{{特別なイベントやオファー}}へのご招待をお送りしています。
あなたは{{招待理由}}から、特別にお選びした{{人数限定}}名様の中のお一人です。
◆ 開催日時：{{日時}}
◆ 開催場所：{{場所}}
◆ 参加費：{{金額}}（通常{{通常金額}}）
【このイベントで得られるもの】
このイベントでは、以下のような価値ある内容をご提供いたします：',
ARRAY['イベントやオファー', '挨拶', '会社・団体名', '招待理由', '人数限定', '日時', '場所', '金額', '通常金額'],
true,
'特別なイベントや限定オファーへの招待状形式で、選ばれた人だけが参加できるという特別感を演出するフォーミュラです。限定性と特別感を強調し、招待された側に価値を感じさせることで参加率を高めます。セミナー、イベント、会員限定オファーなどの告知に効果的です。'),

('悩み（2人比較型）', 'ad_copy',
'「{{問題や悩み}}」を乗り越えた{{成功者}}と、いまだに苦しむ{{失敗者}}の違い
{{挨拶}}
あなたは、{{問題や悩み}}に悩まされていませんか？
この問題に直面している人はあなただけではありません。実は、多くの{{ターゲット層}}が同じ悩みを抱えているのです。
しかし、同じ悩みを持っていた人の中にも、すでにこの問題を解決し、{{理想的な状態}}を実現している人がいます。一方で、いまだに苦しみ続けている人もいます。
ではなぜ、こんなにも大きな差が生まれるのでしょうか？
【成功している{{成功者}}の場合】
{{成功者}}さん（{{成功者の属性}}）は、以前は{{成功者の過去の状況}}という状況でした。',
ARRAY['問題や悩み', '成功者', '失敗者', '挨拶', 'ターゲット層', '理想的な状態', '成功者の属性', '過去の状況'],
true,
'同じ問題を抱えていた2人の対照的な結果を比較することで、正しい選択の重要性を強調するフォーミュラです。成功者と失敗者の違いを明確に示し、読者が望む側（成功者）になるための具体的な方法を提案します。読者の共感を呼び起こし、行動を促すのに効果的です。'),

('サブスクレター型', 'ad_copy',
'【無料】{{メルマガやニュースレターの名称}}のご案内
{{挨拶}}
あなたは最近、{{業界・分野}}において以下のような変化に気づいていませんか？
• {{業界トレンド1}}
• {{業界トレンド2}}
• {{業界トレンド3}}
これらの変化に対応し、常に最新の情報を得ることは、{{ターゲット層}}にとって非常に重要です。しかし、質の高い情報を効率的に集めるのは容易ではありません。
そこで、{{会社・個人名}}が提供する「{{メルマガやニュースレターの名称}}」をご紹介します。
【{{メルマガやニュースレターの名称}}とは】',
ARRAY['メルマガ名称', '挨拶', '業界・分野', 'トレンド1', 'トレンド2', 'トレンド3', 'ターゲット層', '会社・個人名'],
true,
'無料メルマガやニュースレターへの登録を促すフォーミュラです。業界の最新トレンドや変化を提示し、情報収集の重要性を強調することで、読者に価値ある情報源としての認識を持たせます。定期的な情報提供を通じて、長期的な関係構築を目指す広告に効果的です。');

-- 3. ダミーの基本情報データを挿入（テスト用）
-- 実際の運用では、basic_infosテーブルにデータが必要
INSERT INTO basic_infos (user_id, title, content, summary, generated_by, created_at) VALUES
(
  (SELECT id FROM users WHERE email = 'admin@example.com' LIMIT 1),
  'クラウド会計ソフトウェア基本情報',
  '株式会社FinTechソリューションズが提供するクラウド会計ソフトウェア「SmartAccounts」に関する基本情報です。

【商品・サービスの概要】
SmartAccountsは、中小企業向けのクラウド型会計ソフトウェアで、請求書発行から経費管理、決算書作成まで一気通貫で対応します。インターネット環境があればいつでもどこでも利用可能で、モバイルアプリにも対応しています。

【主な特徴】
- AI搭載のレシート読取機能で経費精算の手間を90%削減
- 銀行口座やクレジットカードと自動連携し、取引データを自動取得
- 税務申告に必要な書類を自動生成し、電子申告にも対応

【想定されるお客様】
従業員50名以下の中小企業、個人事業主、フリーランス。特に、経理担当者が少ない、または経理業務の効率化を図りたい企業に最適です。

【解決できる課題】
経理業務の属人化、手作業による記帳ミス、確定申告時の書類作成負担、リモートワーク時の経理業務遅延などの課題を解決します。

【提供価値】
経理業務の時間を最大70%削減し、本業に集中できる環境を提供します。また、リアルタイムの経営状況の可視化により、的確な経営判断をサポートします。',
  '中小企業向けクラウド会計ソフトウェアの特徴と導入メリットについての基本情報です。',
  'GPT-4',
  NOW() - INTERVAL '10 days'
),
(
  (SELECT id FROM users WHERE email = 'admin@example.com' LIMIT 1),
  'オーガニック食品宅配サービス基本情報',
  '株式会社グリーンテーブルが提供する「オーガニックライフ」に関する基本情報です。

【商品・サービスの概要】
オーガニックライフは、全国の厳選された有機栽培農家から直接仕入れた新鮮な野菜や果物、加工食品を定期的にご自宅にお届けする宅配サービスです。すべての食材は有機JAS認証を取得しており、安心・安全な食生活をサポートします。

【主な特徴】
- 契約農家から直送される完全無農薬・有機栽培の新鮮野菜
- 旬の食材を活かしたレシピ提案とミールキット同梱オプション
- 食材の生産者情報と栽培方法の完全開示による透明性

【想定されるお客様】
健康や食の安全性に関心の高い30〜50代の家族世帯、特に小さなお子様がいるご家庭や、食材の品質にこだわる方々。また、忙しくてスーパーに買い物に行く時間がない共働き世帯にも最適です。

【解決できる課題】
市販の食品に含まれる農薬や添加物への不安、忙しい日常での食材調達の時間的負担、食材の産地や栽培方法の不透明さなどの課題を解決します。',
  '無農薬・有機栽培の新鮮食材を定期宅配するサービスについての基本情報です。',
  'Claude',
  NOW() - INTERVAL '5 days'
),
(
  (SELECT id FROM users WHERE email = 'admin@example.com' LIMIT 1),
  'オンラインヨガスタジオ基本情報',
  'YogaLifeStudioが提供する「どこでもヨガ」に関する基本情報です。

【商品・サービスの概要】
どこでもヨガは、自宅や外出先から参加できるオンラインヨガスタジオです。ライブクラスとオンデマンドレッスンを組み合わせたハイブリッド型で、場所や時間を選ばずに本格的なヨガレッスンを受講できます。初心者から上級者まで、様々なレベルやスタイルのクラスを提供しています。

【主な特徴】
- 一流インストラクターによるライブクラスを毎日20本以上配信
- 500本以上のレッスン動画がいつでも視聴可能なオンデマンドライブラリ
- インストラクターからリアルタイムでポーズの修正やアドバイスが受けられる双方向コミュニケーション

【想定されるお客様】
忙しい仕事や育児でスタジオに通う時間がない方、自宅で気軽にヨガを始めたい初心者、対面レッスンに抵抗がある方、地方在住でヨガスタジオへのアクセスが限られている方など。年齢層は20代から60代まで幅広く対応。

【解決できる課題】
スタジオまでの移動時間や固定スケジュールの制約、初心者の対面レッスンへの心理的ハードル、地方在住者のヨガ教室へのアクセス制限、コロナ禍における運動不足などの課題を解決します。',
  '自宅で気軽に参加できるライブ配信・オンデマンドのヨガレッスンサービスについての基本情報です。',
  'Gemini',
  NOW() - INTERVAL '1 days'
);

-- 4. 使用量ログのテストデータ（必要に応じて）
-- 実際の運用では、広告文生成時に自動的に記録される
INSERT INTO usage_logs (user_id, action_type, generated_by, created_at) VALUES
(
  (SELECT id FROM users WHERE email = 'admin@example.com' LIMIT 1),
  'ad_copy_generation',
  'ChatGPT',
  NOW() - INTERVAL '2 days'
),
(
  (SELECT id FROM users WHERE email = 'admin@example.com' LIMIT 1),
  'ad_copy_generation',
  'Gemini',
  NOW() - INTERVAL '1 days'
),
(
  (SELECT id FROM users WHERE email = 'admin@example.com' LIMIT 1),
  'ad_copy_generation',
  'Claude',
  NOW()
);

-- 5. 広告文履歴ビューの作成（便利のため）
CREATE OR REPLACE VIEW ad_copy_history_view AS
SELECT 
  ac.id,
  ac.user_id,
  ac.title,
  ac.content,
  ac.generated_by as source,
  ac.created_at,
  bi.title as basic_info_title,
  f.name as formula_name
FROM ad_copies ac
LEFT JOIN basic_infos bi ON ac.basic_info_id = bi.id
LEFT JOIN formulas f ON ac.formula_id = f.id
ORDER BY ac.created_at DESC;

-- 実行完了メッセージ
-- このSQLを実行することで、広告文生成機能の動的化に必要な
-- データベース構造とサンプルデータがセットアップされます。